<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Test Game (v2 - Robust Audio)</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #game-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        p {
            color: #555;
            line-height: 1.6;
        }

        #controls button,
        #guess-section button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s ease;
        }

        #controls button:hover,
        #guess-section button:hover {
            background-color: #0056b3;
        }

        #controls button:disabled,
        #guess-section button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #guess-input {
            padding: 10px;
            font-size: 16px;
            margin: 10px 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 22px); /* Adjust for padding and border */
            max-width: 300px;
        }

        #feedback {
            margin-top: 15px;
            font-weight: bold;
            min-height: 1.2em; /* Reserve space to prevent layout jumps */
        }

        #feedback.correct {
            color: #28a745; /* Green */
        }

        #feedback.incorrect {
            color: #dc3545; /* Red */
        }

         #answer {
            margin-top: 10px;
            color: #17a2b8; /* Info blue */
            font-style: italic;
             min-height: 1.2em; /* Reserve space */
        }

        #score {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        /* Hide elements initially */
        #guess-section, #next-btn, #feedback, #answer {
            display: none;
        }
         #audio-player {
             display: none; /* Hide the default audio player controls */
         }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Blind Test Game (v2)</h1>
        <p id="instructions">Press "Start Game" to hear the first song snippet!</p>

        <audio id="audio-player" preload="auto"></audio> <div id="controls">
            <button id="start-btn">Start Game</button>
            <button id="play-btn" disabled>Play Snippet</button> <button id="next-btn">Next Song</button>
        </div>

        <div id="guess-section">
            <input type="text" id="guess-input" placeholder="Enter song title guess">
            <button id="submit-btn">Submit Guess</button>
        </div>

        <div id="feedback"></div>
        <div id="answer"></div>
        <div id="score">Score: 0 / 0</div>
    </div>

    <script>
        // --- Configuration ---
        const snippetDuration = 10; // Play snippet for 10 seconds
        const songs = [
             // Using the same 20 copyright-free songs from previous version
            { title: "Lofi Study", artist: "FASSounds", url: "https://cdn.pixabay.com/audio/2022/05/27/audio_1819c1671f.mp3" },
            { title: "The Beat of Nature", artist: "Olexy", url: "https://cdn.pixabay.com/audio/2022/01/18/audio_ea80767449.mp3" },
            { title: "Smoke", artist: "SoulProdMusic", url: "https://cdn.pixabay.com/audio/2023/08/01/audio_a3007a175f.mp3" },
            { title: "Ambient Classical Guitar", artist: "William_King", url: "https://cdn.pixabay.com/audio/2023/05/29/audio_7e4b166b89.mp3" },
            { title: "Tropical Summer", artist: "Luke Bergs", url: "https://cdn.pixabay.com/audio/2021/08/09/audio_a81e2f9802.mp3" },
            { title: "In the Moment", artist: "Alexi Action", url: "https://cdn.pixabay.com/audio/2022/12/21/audio_340d2b1a49.mp3" },
            { title: "Emotional Cinematic Piano", artist: "Oleksii Holzu", url: "https://cdn.pixabay.com/audio/2024/03/13/audio_1ec019d9a3.mp3" },
            { title: "Future Bass", artist: "Music_For_Videos", url: "https://cdn.pixabay.com/audio/2023/08/03/audio_5db097e36b.mp3" },
            { title: "Just Relax", artist: "Lesfm", url: "https://cdn.pixabay.com/audio/2021/11/23/audio_8c1398b720.mp3" },
            { title: "Good Night", artist: "FASSounds", url: "https://cdn.pixabay.com/audio/2022/04/07/audio_7961d3705c.mp3" },
            { title: "Inspiring Cinematic Ambient", artist: "Lexin_Music", url: "https://cdn.pixabay.com/audio/2022/08/04/audio_2dead139f7.mp3" },
            { title: "Epic Cinematic", artist: "AudioCoffee", url: "https://cdn.pixabay.com/audio/2024/01/14/audio_3b347c941a.mp3" },
            { title: "Ukulele Fun", artist: "Playsound", url: "https://cdn.pixabay.com/audio/2022/06/14/audio_4f3b015f6a.mp3" },
            { title: "Medieval Tale", artist: "Vadim Krakhmal", url: "https://cdn.pixabay.com/audio/2023/09/22/audio_7d8896b617.mp3" },
            { title: "Spirit Blossom", artist: "RomanSenykMusic", url: "https://cdn.pixabay.com/audio/2022/02/07/audio_67c71a8418.mp3" },
            { title: "Morning Garden Acoustic", artist: "Olexy", url: "https://cdn.pixabay.com/audio/2022/10/11/audio_5708164799.mp3" },
            { title: "Powerful Beat", artist: "RedLionProduction", url: "https://cdn.pixabay.com/audio/2024/03/30/audio_c0d2a49747.mp3" },
            { title: "The Introvert", artist: "Michael Kobrin", url: "https://cdn.pixabay.com/audio/2021/11/17/audio_7945c36c37.mp3" },
            { title: "8 Bit Retro", artist: "ComaStudio", url: "https://cdn.pixabay.com/audio/2022/01/27/audio_a31f865623.mp3" },
            { title: "Empty Mind", artist: "Lofi_hour", url: "https://cdn.pixabay.com/audio/2023/11/05/audio_40614c1b40.mp3" }
        ];

        // --- Game State Variables ---
        let currentSongIndex = -1;
        let score = 0;
        let playedIndices = new Set();
        let currentAudioTimeout = null;
        let audioLoadError = false; // Flag for loading errors

        // --- DOM Elements ---
        const startBtn = document.getElementById('start-btn');
        const playBtn = document.getElementById('play-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const guessInput = document.getElementById('guess-input');
        const feedbackDiv = document.getElementById('feedback');
        const answerDiv = document.getElementById('answer');
        const scoreDiv = document.getElementById('score');
        const instructionsP = document.getElementById('instructions');
        const guessSectionDiv = document.getElementById('guess-section');
        const audioPlayer = document.getElementById('audio-player');

        // --- Event Handlers (defined once) ---
        const onCanPlayThrough = () => {
            console.log(`Audio ready: ${songs[currentSongIndex]?.title}`); // Debugging
            audioLoadError = false; // Reset error flag on successful load
            playBtn.disabled = false; // Enable play button ONLY when audio is ready
            instructionsP.textContent = `Song ${playedIndices.size} of ${songs.length}. Press "Play Snippet".`;
            // Remove this specific listener instance cleanly
            audioPlayer.removeEventListener('canplaythrough', onCanPlayThrough);
            audioPlayer.removeEventListener('error', onAudioLoadError); // Also remove error listener for this load attempt
        };

        const onAudioLoadError = (e) => {
            const songTitle = songs[currentSongIndex]?.title || 'Unknown Song';
            console.error(`Audio loading error for ${songTitle}:`, e);
            feedbackDiv.textContent = `Error loading: ${songTitle}. Check URL or network. Skipping.`;
            feedbackDiv.className = 'incorrect';
            feedbackDiv.style.display = 'block';
            audioLoadError = true; // Set error flag

            // UI Updates for load error
            playBtn.disabled = true; // Keep play button disabled
            submitBtn.disabled = true; // Disable guessing if audio failed to load
            guessInput.disabled = true;

            nextBtn.style.display = 'inline-block'; // Show next button immediately
            if (playedIndices.size >= songs.length) {
                nextBtn.textContent = "Show Final Score";
            } else {
                nextBtn.textContent = "Next Song";
            }
             // Remove this specific listener instance cleanly
            audioPlayer.removeEventListener('canplaythrough', onCanPlayThrough);
            audioPlayer.removeEventListener('error', onAudioLoadError);
        };


        // --- Functions ---

        function getRandomSongIndex() {
            if (playedIndices.size >= songs.length) {
                return -1; // No more unique songs left
            }
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * songs.length);
            } while (playedIndices.has(randomIndex));
            playedIndices.add(randomIndex);
            return randomIndex;
        }

        function loadSong() {
            // Stop any currently playing snippet immediately
            if (currentAudioTimeout) {
                clearTimeout(currentAudioTimeout);
                currentAudioTimeout = null;
            }
             if (!audioPlayer.paused) {
                 audioPlayer.pause();
             }


            currentSongIndex = getRandomSongIndex();
            audioLoadError = false; // Reset error flag for the new song

            if (currentSongIndex === -1) {
                endGame("You've heard all the songs!");
                return false;
            }

            const song = songs[currentSongIndex];
            console.log(`Loading song ${playedIndices.size}: ${song.title
